@using System.Security.Claims
@using ReviewEverything.Shared.Contracts.Responses;
@inherits LayoutComponentBase

<MudThemeProvider IsDarkMode="IsDarkMode" />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>

    <MudAppBar Elevation="1">
        <MudBreakpointProvider>
            <MudHidden Breakpoint="Breakpoint.SmAndDown" Invert="true">
                <div style="display: flex; width: 100%; justify-content: space-between; align-items: center;">
                    <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="ChangeDrawerOpen" />
                    <MudLink Style="display: flex; align-items: center;" Color="Color.Inherit" Href="./" Underline="Underline.None">
                        <MudIcon Style="height: 30px; width: 30px;" Icon="@Icons.Filled.Camera" />
                        <MudText Style="font-size: 18px;">Reviews of everything</MudText>
                    </MudLink>
                    <MudIconButton OnClick="OpenSearchDialog" Color="Color.Inherit" Icon="@Icons.Filled.Search" />
                </div>
            </MudHidden>
            <MudHidden Breakpoint="Breakpoint.MdAndUp" Invert="true">
                <div style="display: flex; align-items: center;">
                    <MudLink Style="display: flex; align-items: center;" Color="Color.Inherit" Href="./" Underline="Underline.None">
                        <MudIcon Style="height: 30px; width: 30px;" Icon="@Icons.Filled.Camera" />
                        <MudText Style="font-size: 24px;">Reviews of everything</MudText>
                    </MudLink>
                    <span class="mx-3"></span>
                    <AuthorizeView Policy="Admin">
                        <Authorized>
                            <MudMenu TransformOrigin="Origin.TopCenter" AnchorOrigin="Origin.BottomCenter" FullWidth="true">
                                <ActivatorContent>
                                    <MudButton StartIcon="@Icons.Material.Filled.Security" Variant="Variant.Outlined" Color="Color.Inherit">Панель управления</MudButton>
                                </ActivatorContent>
                                <ChildContent>
                                    <MudMenuItem Href="/admin/category">Категории</MudMenuItem>
                                </ChildContent>
                            </MudMenu>
                            <span class="mx-1"></span>
                        </Authorized>
                    </AuthorizeView>
                    <AuthorizeView>
                        <Authorized>
                            <MudMenu TransformOrigin="Origin.TopCenter" AnchorOrigin="Origin.BottomCenter">
                                <ActivatorContent>
                                    <MudButton StartIcon="@Icons.Material.Filled.Person" Variant="Variant.Outlined" Color="Color.Inherit">Аккаунт</MudButton>
                                </ActivatorContent>
                                <ChildContent>
                                    <MudMenuItem Href="@($"./user/{context.User.Claims.First(claim => claim.Type == ClaimTypes.NameIdentifier).Value}")">Моя страница</MudMenuItem>
                                    <MudMenuItem>Настройки</MudMenuItem>
                                </ChildContent>
                            </MudMenu>
                            <span class="mx-1"></span>
                        </Authorized>
                    </AuthorizeView>
                </div>
                <MudSpacer />
                <MudIconButton OnClick="OpenSearchDialog" Color="Color.Inherit" Icon="@Icons.Filled.Search" />
                <MudToggleIconButton Color="Color.Inherit" Toggled="IsDarkMode" ToggledChanged="ChangeThemeAsync" Icon="@Icons.Filled.WbSunny" ToggledIcon="@Icons.Filled.NightsStay" />
                <CascadingValue Value="this">
                    <LoginPartial />
                </CascadingValue>
            </MudHidden>
            <span class="mx-1"></span>
        </MudBreakpointProvider>
    </MudAppBar>

    <MudBreakpointProvider>
        <MudHidden Breakpoint="Breakpoint.SmAndDown" Invert="true">
            <MudDrawer @bind-Open="DrawerOpen" Elevation="2">
                <MudDrawerHeader Style="@("background: " + (IsDarkMode ? "#151521ff" : "#f5f5f5ff"))" Dense="true">
                    <MudSpacer />
                    <MudToggleIconButton Size="Size.Small" ToggledSize="Size.Small" Color="Color.Inherit" Toggled="IsDarkMode" ToggledChanged="ChangeThemeAsync" Icon="@Icons.Filled.WbSunny" ToggledIcon="@Icons.Filled.NightsStay" />
                </MudDrawerHeader>
                <MudList Clickable="true">
                    <CascadingValue Value="this">
                        <LoginPartial />
                    </CascadingValue>
                    <CascadingValue Value="this">
                        <MoblieNavLink />
                    </CascadingValue>
                </MudList>
            </MudDrawer>
        </MudHidden>
    </MudBreakpointProvider>

    <MudDialog @bind-IsVisible="_searchDialogOpen" Options="_dialogOptions" Class="docs-gray-bg" ClassContent="docs-mobile-dialog-search">
        <DialogContent>
            <MudAutocomplete @ref="_searchAutocomplete" T="ReviewSearchResponse" PopoverClass="docs-mobile-dialog-search-popover" Placeholder="Search review" SearchFunc="Search" ValueChanged="OnSearchResult" Clearable="true" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search">
                <ItemTemplate Context="result">
                    <MudText>@result.Title</MudText>
                </ItemTemplate>
            </MudAutocomplete>
            <div class="d-flex justify-center align-center mud-height-full pb-16" style="width:300px; height:30vh;">
                <MudText Typo="Typo.body2" Class="mud-text-secondary">Nothing found, do a search</MudText>
            </div>
        </DialogContent>
    </MudDialog>

    <MudMainContent>
        <CascadingValue Value="this">
            @Body
        </CascadingValue>
    </MudMainContent>
</MudLayout>